using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Xml;
using System.Drawing;
using CSKernelClient;

namespace CSReportDll
{
    public class cReportImage
    {
        private cReportAspect m_aspect;
        private Image m_image = null;

        public cReportImage()
        {
            m_aspect = new cReportAspect();
        }

        // TODO: check if we need to free image resources
        /*
        private void class_Terminate()
        {
            m_aspect = null;
            if (m_hImage != 0) { DeleteObject(m_hImage); }
        }
         * 
         */

        public cReportAspect getAspect()
        {
            return m_aspect;
        }

        public void setAspect(cReportAspect rhs)
        {
            m_aspect = rhs;
        }

        public Image getImage()
        {
            return m_image;
        }

        public void setImage(Image rhs)
        {
            m_image = rhs;
        }

        internal bool load(CSXml.cXml xDoc, XmlElement nodObj)
        {
            CSXml.cXmlProperty xProperty = null;
            nodObj = xDoc.getNodeFromNode(nodObj, "Image");
            byte[] vBytes = null;
            vBytes = xDoc.getBinaryNodeProperty(nodObj, "Data").getBinaryValue();
            if (vBytes.Length > 0)
            {
                cImage.deSerialiseBitmap(m_image, vBytes);
            }

            G.redim(ref vBytes, 0);

            if (!m_aspect.load(xDoc, nodObj))
            {
                return false;
            }
            else
            {
                return true;
            }
        }

        internal bool save(CSXml.cXml xDoc, XmlElement nodeFather)
        {
            CSXml.cXmlProperty xProperty = null;
            XmlElement nodObj = null;
            object nodImage = null;

            xProperty = new CSXml.cXmlProperty();
            xProperty.setName("Image");
            nodObj = xDoc.addNodeToNode(nodeFather, xProperty);

            byte[] vBytes = null;
            if (getImage() != 0)
            {
                cImage.serialiseBitmap(getImage(), vBytes);
            }
            else
            {
                G.redim(ref vBytes, 0);
            }
            xProperty.setName("Data");
            xProperty.setBinaryValue(vBytes);

            xDoc.addBinaryPropertyToNode(nodObj, xProperty);
            G.redim(ref vBytes, 0);

            if (!m_aspect.save(xDoc, nodObj))
            {
                return true;
            }
            else
            {
                return false;
            }
        }

    }

}
